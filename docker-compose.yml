services:

  # caddy service
  proxy-client-caddy:
    image: caddy:${PROXY_CLIENT_CADDY_VERSION}
    entrypoint: ["/usr/local/bin/entrypoint.sh"]
    container_name: proxy-client-caddy
    restart: unless-stopped
    depends_on:
      - proxy-client-socks5h
    environment:
      AUTHENTIK_APP_HOSTNAME: ${PROXY_CLIENT_CADDY_AUTHENTIK_APP_HOSTNAME}
      AUTHENTIK_APP_CONTAINER: ${PROXY_CLIENT_CADDY_AUTHENTIK_APP_CONTAINER}
      OUTLINE_APP_HOSTNAME: ${PROXY_CLIENT_CADDY_OUTLINE_APP_HOSTNAME}
      OUTLINE_APP_CONTAINER: ${PROXY_CLIENT_CADDY_OUTLINE_APP_CONTAINER}
      FIREFLY_APP_HOSTNAME: ${PROXY_CLIENT_CADDY_FIREFLY_APP_HOSTNAME}
      FIREFLY_APP_CONTAINER: ${PROXY_CLIENT_CADDY_FIREFLY_APP_CONTAINER}
      YOUTRACK_APP_HOSTNAME: ${PROXY_CLIENT_CADDY_YOUTRACK_APP_HOSTNAME}
      YOUTRACK_APP_CONTAINER: ${PROXY_CLIENT_CADDY_YOUTRACK_APP_CONTAINER}      
      http_proxy: socks5h://proxy-client-socks5h:${PROXY_SOCKS5H_PORT}
      https_proxy: socks5h://proxy-client-socks5h:${PROXY_SOCKS5H_PORT}
      no_proxy: ${PROXY_CLIENT_CADDY_NO_PROXY}
    volumes:
      - ./usr/local/bin/entrypoint.sh:/usr/local/bin/entrypoint.sh:ro
      - ./vol/proxy-client-caddy/data:/data
      - ./vol/proxy-client-caddy/config:/config
    networks:
      proxy-client-private:
      proxy-client-authentik:
      proxy-client-outline:
      proxy-client-firefly:
      proxy-client-youtrack:      

  # frpc for connect to frps
  proxy-client-caddy-frpc:
    image: ghcr.io/ldev1281/docker-frp:latest
    container_name: proxy-client-caddy-frpc
    restart: unless-stopped
    depends_on:
      - proxy-client-frps-host
      - proxy-client-caddy
    environment:
      - FRP_HOST=proxy-client-frps-host
      - FRP_PORT=${PROXY_FRP_PORT}
      - FRP_TOKEN=${PROXY_FRP_TOKEN}
    networks:
      proxy-client-private:

  # proxy to frp server
  proxy-client-frps-host:
    image: ghcr.io/ldev1281/docker-socat-socks5:latest
    container_name: proxy-client-frps-host
    restart: unless-stopped
    environment:
      LISTEN_PORT: ${PROXY_FRP_PORT}
      TARGET_HOST: ${PROXY_HOST}
      TARGET_PORT: ${PROXY_FRP_PORT}
    networks:
      proxy-client-universe:
      proxy-client-private:

  # proxy output from caddy
  proxy-client-socks5h:
    image: ghcr.io/ldev1281/docker-socat-socks5:latest
    container_name: proxy-client-socks5h
    restart: unless-stopped
    environment:
      LISTEN_PORT: ${PROXY_SOCKS5H_PORT}
      TARGET_HOST: ${PROXY_HOST}
      TARGET_PORT: ${PROXY_SOCKS5H_PORT}
    networks:
      proxy-client-universe:
      proxy-client-private:

  # smtp proxy
  proxy-client-smtp:
    image: ghcr.io/ldev1281/docker-socat-socks5:latest
    container_name: proxy-client-smtp
    restart: unless-stopped
    environment:
      LISTEN_PORT: ${PROXY_CLIENT_SMTP_PORT}
      TARGET_HOST: ${PROXY_CLIENT_SMTP_HOST}
      TARGET_PORT: ${PROXY_CLIENT_SMTP_PORT}
      SOCKS5_HOST: ${PROXY_HOST:-}
      SOCKS5_PORT: ${PROXY_SOCKS5H_PORT:-}
    networks:
      proxy-client-universe:
      proxy-client-authentik:
        aliases:
          - ${PROXY_CLIENT_SMTP_HOST}
      proxy-client-outline:
        aliases:
          - ${PROXY_CLIENT_SMTP_HOST}
      proxy-client-firefly:
        aliases:
          - ${PROXY_CLIENT_SMTP_HOST}
      proxy-client-youtrack:
        aliases:
          - ${PROXY_CLIENT_SMTP_HOST}

  # authentik proxy
  proxy-client-authentik:
    image: ghcr.io/ldev1281/docker-socat-socks5:latest
    container_name: proxy-client-authentik
    restart: unless-stopped
    environment:
      LISTEN_PORT: 443
      TARGET_HOST: ${PROXY_CLIENT_CADDY_AUTHENTIK_APP_HOSTNAME}
      TARGET_PORT: 443
      SOCKS5_HOST: ${PROXY_HOST:-}
      SOCKS5_PORT: ${PROXY_SOCKS5H_PORT:-}
    networks:
      proxy-client-universe:
      proxy-client-outline:
        aliases:
          - ${PROXY_CLIENT_CADDY_AUTHENTIK_APP_HOSTNAME}
      proxy-client-firefly:
        aliases:
          - ${PROXY_CLIENT_CADDY_AUTHENTIK_APP_HOSTNAME}
      proxy-client-youtrack:
        aliases:
          - ${PROXY_CLIENT_CADDY_AUTHENTIK_APP_HOSTNAME}

networks:

  proxy-client-universe:
    name: proxy-client-universe
    driver: bridge

  proxy-client-private:
    name: proxy-client-private
    driver: bridge
    internal: true

  proxy-client-authentik:
    name: proxy-client-authentik
    external: true

  proxy-client-outline:
    name: proxy-client-outline
    external: true

  proxy-client-firefly:
    name: proxy-client-firefly
    external: true

  proxy-client-youtrack:
    name: proxy-client-youtrack
    external: true
