services:

  # caddy service
  caddy:
    image: caddy:latest
    entrypoint: ["/usr/local/bin/caddy-entrypoint.sh"]
    container_name: caddy
    restart: unless-stopped
    environment:
      KEYCLOAK_APP_HOSTNAME: ${KEYCLOAK_APP_HOSTNAME}
      KEYCLOAK_APP_HOST: ${KEYCLOAK_APP_HOST}
      FIREFLY_APP_HOSTNAME: ${FIREFLY_APP_HOSTNAME}
      FIREFLY_APP_HOST: ${FIREFLY_APP_HOST}
      WEKAN_APP_HOSTNAME: ${WEKAN_APP_HOSTNAME}
      WEKAN_APP_HOST: ${WEKAN_APP_HOST}
      http_proxy: socks5://${PROXY_CLIENT_SOCAT_DANTE_USER}:${PROXY_CLIENT_SOCAT_DANTE_PASSWORD}@proxy-client-caddy-socat-socks5h-dante:${PROXY_CLIENT_SOCAT_DANTE_PORT}
      https_proxy: socks5://${PROXY_CLIENT_SOCAT_DANTE_USER}:${PROXY_CLIENT_SOCAT_DANTE_PASSWORD}@proxy-client-caddy-socat-socks5h-dante:${PROXY_CLIENT_SOCAT_DANTE_PORT}
      no_proxy: "localhost,127.0.0.1,::1,*.local,*.localhost,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,firefly-app,wekan-app,keycloak-app,outline-app"
    volumes:
      - ./usr/local/bin/caddy-entrypoint.sh:/usr/local/bin/caddy-entrypoint.sh:ro
      - ./vol/caddy/data:/data
      - ./vol/caddy/config:/config
    networks:
      - proxy-client-private
      - proxy-client-keycloak
      - proxy-client-firefly
      - proxy-client-wekan

  # frpc for connect to frps
  caddy-frp-client:
    image: ghcr.io/ldev1281/docker-frp:latest
    container_name: caddy-frp-client
    restart: unless-stopped
    depends_on:
      - proxy-client-socat-socks5h-frp
    environment:
      - FRP_HOST=proxy-client-socat-socks5h-frp
      - FRP_PORT=${PROXY_CLIENT_SOCAT_FRP_PORT}
      - FRP_TOKEN=${PROXY_CLIENT_SOCAT_FRP_TOKEN}
    networks:
      - proxy-client-private

  # proxy output from caddy
  proxy-client-caddy-socat-socks5h-dante:
    image: ghcr.io/ldev1281/docker-socat-socks5h:latest
    container_name: proxy-client-caddy-socat-socks5h-dante
    restart: unless-stopped
    environment:
      LISTEN_PORT: ${PROXY_CLIENT_SOCAT_DANTE_PORT}
      TARGET_HOST: ${PROXY_CLIENT_SOCAT_DANTE_HOST}
      TARGET_PORT: ${PROXY_CLIENT_SOCAT_DANTE_PORT}
    networks:
      - proxy-client-universe
      - proxy-client-private

  # proxy to frp server
  proxy-client-socat-socks5h-frp:
    image: ghcr.io/ldev1281/docker-socat-socks5h:latest
    container_name: proxy-client-socat-socks5h-frp
    restart: unless-stopped
    environment:
      LISTEN_PORT: ${PROXY_CLIENT_SOCAT_FRP_PORT}
      TARGET_HOST: ${PROXY_CLIENT_SOCAT_FRP_HOST}
      TARGET_PORT: ${PROXY_CLIENT_SOCAT_FRP_PORT}
    networks:
      - proxy-client-universe
      - proxy-client-private

  # smtp proxy
  proxy-client-socat-socks5h-smtp:
    image: ghcr.io/ldev1281/docker-socat-socks5h:latest
    container_name: proxy-client-socat-socks5h-smtp
    restart: unless-stopped
    environment:
      LISTEN_PORT: ${PROXY_CLIENT_SOCAT_SMTP_PORT}
      TARGET_HOST: ${PROXY_CLIENT_SOCAT_SMTP_HOST}
      TARGET_PORT: ${PROXY_CLIENT_SOCAT_SMTP_PORT}
      SOCKS5H_HOST: ${PROXY_CLIENT_SOCAT_SMTP_SOCKS5H_HOST:-}
      SOCKS5H_PORT: ${PROXY_CLIENT_SOCAT_SMTP_SOCKS5H_PORT:-}
      SOCKS5H_USER: ${PROXY_CLIENT_SOCAT_SMTP_SOCKS5H_USER:-}
      SOCKS5H_PASSWORD: ${PROXY_CLIENT_SOCAT_SMTP_SOCKS5H_PASSWORD:-}
    networks:
      proxy-client-universe: {}
      proxy-client-keycloak:
        aliases:
          - smtp.mailgun.org
      proxy-client-firefly:
        aliases:
          - smtp.mailgun.org
      proxy-client-wekan:
        aliases:
          - smtp.mailgun.org

      

networks:
  proxy-client-universe:
    name: proxy-client-universe
    driver: bridge

  proxy-client-private:
    name: proxy-client-private
    driver: bridge
    internal: true

  proxy-client-keycloak:
    name: proxy-client-keycloak
    external: true

  proxy-client-firefly:
    name: proxy-client-firefly
    external: true

  proxy-client-wekan:
    name: proxy-client-wekan
    external: true